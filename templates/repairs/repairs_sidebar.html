{% load custom_filters %}

<nav class="col-md-2 d-none d-md-block bg-light sidebar">
    <div class="sidebar-sticky">

        <!-- Юридические лица -->
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="legalEntityDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate">
                    {% if selected_entity %}
                        {{ selected_entity.name }}
                    {% else %}
                        Все юридические лица
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="legalEntityDropdown">
                <li>
                    <a class="dropdown-item {% if not selected_entity %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}&department={{ selected_department.id|default_if_none:'' }}&shop={{ selected_shop.id|default_if_none:'' }}&pos={{ selected_pos.id|default_if_none:'' }}">
                        Все юридические лица
                    </a>
                </li>
                {% for entity in legal_entities %}
                <li>
                    <a class="dropdown-item text-truncate {% if selected_entity and entity.id == selected_entity.id %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ entity.id }}&department={{ selected_department.id|default_if_none:'' }}&shop={{ selected_shop.id|default_if_none:'' }}&pos={{ selected_pos.id|default_if_none:'' }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        {{ entity.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Подразделения -->
        {% if departments %}
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="departmentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate">
                    {% if selected_department %}
                        {{ selected_department.name }}
                    {% else %}
                        Все подразделения
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="departmentDropdown">
                <li>
                    <a class="dropdown-item {% if not selected_department %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ selected_entity.id|default_if_none:'' }}&shop={{ selected_shop.id|default_if_none:'' }}&pos={{ selected_pos.id|default_if_none:'' }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        Все подразделения
                    </a>
                </li>
                {% for department in departments %}
                <li>
                    <a class="dropdown-item text-truncate {% if selected_department and department.id == selected_department.id %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ selected_entity.id|default_if_none:'' }}&department={{ department.id }}&shop={{ selected_shop.id|default_if_none:'' }}&pos={{ selected_pos.id|default_if_none:'' }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        {{ department.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Цеха -->
        {% if shops %}
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="shopDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate">
                    {% if selected_shop %}
                        {{ selected_shop.name }}
                    {% else %}
                        Все цеха
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="shopDropdown">
                <li>
                    <a class="dropdown-item {% if not selected_shop %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ selected_entity.id|default_if_none:'' }}&department={{ selected_department.id|default_if_none:'' }}&pos={{ selected_pos.id|default_if_none:'' }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        Все цеха
                    </a>
                </li>
                {% for shop in shops %}
                <li>
                    <a class="dropdown-item text-truncate {% if selected_shop and shop.id == selected_shop.id %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ selected_entity.id|default_if_none:'' }}&department={{ selected_department.id|default_if_none:'' }}&shop={{ shop.id }}&pos={{ selected_pos.id|default_if_none:'' }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        {{ shop.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Позиции -->
        {% if positions %}
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="positionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate">
                    {% if selected_pos %}
                        {{ selected_pos.pos }}
                    {% else %}
                        Все позиции
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="positionDropdown">
                <li>
                    <a class="dropdown-item {% if not selected_pos %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ selected_entity.id|default_if_none:'' }}&department={{ selected_department.id|default_if_none:'' }}&shop={{ selected_shop.id|default_if_none:'' }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        Все позиции
                    </a>
                </li>
                {% for pos in positions %}
                <li>
                    <a class="dropdown-item text-truncate {% if selected_pos and pos.id == selected_pos.id %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legalentity={{ selected_entity.id|default_if_none:'' }}&department={{ selected_department.id|default_if_none:'' }}&shop={{ selected_shop.id|default_if_none:'' }}&pos={{ pos.id }}&start_date_from={{ start_date_from|default_if_none:'' }}&start_date_to={{ start_date_to|default_if_none:'' }}">
                        {{ pos.pos }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Фильтр по дате начала -->
        <form method="get" class="mt-3 px-2">
            <div class="mb-2">
                <label for="start_date_from" class="form-label">Дата начала с</label>
                <input type="date" id="start_date_from" name="start_date_from" class="form-control"
                       value="{{ start_date_from|default_if_none:'' }}">
            </div>
            <div class="mb-2">
                <label for="start_date_to" class="form-label">Дата начала по</label>
                <input type="date" id="start_date_to" name="start_date_to" class="form-control"
                       value="{{ start_date_to|default_if_none:'' }}">
            </div>
            {% if selected_entity %}
                <input type="hidden" name="legalentity" value="{{ selected_entity.id }}">
            {% endif %}
            {% if selected_department %}
                <input type="hidden" name="department" value="{{ selected_department.id }}">
            {% endif %}
            {% if selected_shop %}
                <input type="hidden" name="shop" value="{{ selected_shop.id }}">
            {% endif %}
            {% if selected_pos %}
                <input type="hidden" name="pos" value="{{ selected_pos.id }}">
            {% endif %}
            <button type="submit" class="btn btn-primary w-100">Фильтровать по дате начала</button>
        </form>

        <!-- Кнопка добавления ремонта -->
        <div class="mt-4">
            <a href="{% url 'repairs:repairs_add' %}" class="btn btn-success w-100">Добавить ремонт</a>
        </div>
    </div>
</nav>
{% load custom_filters %}

<nav class="col-md-2 d-none d-md-block bg-light sidebar">
    <div class="sidebar-sticky">
        <!-- Legal Entity Dropdown -->
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="legalEntityDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate" style="max-width: 100%;">
                    {% if request.GET.legal_entity %}
                        {{ legal_entities|get_by_id:request.GET.legal_entity }}
                    {% else %}
                        All Legal Entities
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="legalEntityDropdown">
                <li>
                    <a class="dropdown-item {% if not request.GET.legal_entity %}active{% endif %}" href="{% url 'repairs:repairs_list' %}">
                        All Legal Entities
                    </a>
                </li>
                {% for entity in legal_entities %}
                <li>
                    <a class="dropdown-item text-truncate {% if request.GET.legal_entity == entity.id|stringformat:"s" %}active{% endif %}" style="max-width: 100%;" href="{% url 'repairs:repairs_list' %}?legal_entity={{ entity.id }}">
                        {{ entity.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Shop Dropdown -->
        {% if shops %}
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="shopDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate" style="max-width: 100%;">
                    {% if request.GET.shop %}
                        {{ shops|get_by_id:request.GET.shop }}
                    {% else %}
                        All Shops
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="shopDropdown">
                <li>
                    <a class="dropdown-item {% if not request.GET.shop %}active{% endif %}" href="{% url 'repairs:repairs_list' %}?legal_entity={{ request.GET.legal_entity|default:'' }}">
                        All Shops
                    </a>
                </li>
                {% for shop in shops %}
                <li>
                    <a class="dropdown-item text-truncate {% if request.GET.shop == shop.id|stringformat:"s" %}active{% endif %}" style="max-width: 100%;" href="{% url 'repairs:repairs_list' %}?legal_entity={{ request.GET.legal_entity|default:'' }}&shop={{ shop.id }}">
                        {{ shop.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Position Dropdown -->
        {% if positions %}
        <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" id="positionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="d-inline-block text-truncate" style="max-width: 100%;">
                    {% if request.GET.equipment_pos %}
                        {{ positions|get_by_id:request.GET.equipment_pos }}
                    {% else %}
                        All Positions
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="positionDropdown">
                <li>
                    <a class="dropdown-item {% if not request.GET.equipment_pos %}active{% endif %}"
                       href="{% url 'repairs:repairs_list' %}?legal_entity={{ request.GET.legal_entity|default:'' }}&shop={{ request.GET.shop|default:'' }}">
                        All Positions
                    </a>
                </li>
                {% for pos in positions %}
                <li>
                    <a class="dropdown-item text-truncate {% if request.GET.equipment_pos == pos.id|stringformat:"s" %}active{% endif %}"
                       style="max-width: 100%;"
                       href="{% url 'repairs:repairs_list' %}?legal_entity={{ request.GET.legal_entity|default:'' }}&shop={{ request.GET.shop|default:'' }}&equipment_pos={{ pos.id }}">
                        {{ pos.pos }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Start Date Filter -->
        <form method="get" class="mt-3 px-2">
            <div class="mb-2">
                <label for="start_date_from" class="form-label">Start Date From</label>
                <input type="date" id="start_date_from" name="start_date_from" class="form-control"
                       value="{{ start_date_from|default_if_none:'' }}">
            </div>
            <div class="mb-2">
                <label for="start_date_to" class="form-label">Start Date To</label>
                <input type="date" id="start_date_to" name="start_date_to" class="form-control"
                       value="{{ start_date_to|default_if_none:'' }}">
            </div>
            <!-- Preserve other filters -->
            {% if request.GET.legal_entity %}
                <input type="hidden" name="legal_entity" value="{{ request.GET.legal_entity }}">
            {% endif %}
            {% if request.GET.shop %}
                <input type="hidden" name="shop" value="{{ request.GET.shop }}">
            {% endif %}
            {% if request.GET.equipment_pos %}
                <input type="hidden" name="equipment_pos" value="{{ request.GET.equipment_pos }}">
            {% endif %}
            <button type="submit" class="btn btn-primary w-100">Filter by Start Date</button>
        </form>

        <!-- Add Repair Entry Button -->
        <div class="mt-4">
            <a href="{% url 'repairs:repairs_add' %}" class="btn btn-success w-100">Add Repair Entry</a>
        </div>
    </div>
</nav>